# VA Benefits Navigator — Comprehensive Audit Report

**Date:** 2026-02-09
**Auditor:** Claude Code (Opus 4.6)
**Scope:** Full codebase audit across 7 areas
**Production-Readiness Score:** 5.5 / 10

---

## Executive Summary

| # | Audit Section | Status | Critical | Needs Work |
|---|---|---|---|---|
| 1 | Security | CRITICAL | 4 | 3 |
| 2 | Data Integrity & Accuracy | CRITICAL | 2 | 1 |
| 3 | Test Coverage & Quality | NEEDS WORK | 0 | 4 |
| 4 | Production Readiness | NEEDS WORK | 1 | 2 |
| 5 | Accessibility (WCAG AA) | NEEDS WORK | 3 | 4 |
| 6 | Code Quality & Deployment | CRITICAL | 2 | 5 |
| **Totals** | | | **12 CRITICAL** | **19 NEEDS WORK** |

The application has strong architecture, 360+ passing tests, and excellent security patterns (encryption, signed URLs, AI Gateway). Exposed secrets, outdated compensation rates, and missing Celery crash-safety are blocking issues.

---

## 1. Security Audit

### 1a. Secrets in Version Control — CRITICAL

**Files:** `app-spec-fixed.yaml`, `.do/app.yaml`, `.env`

Production credentials hardcoded in version control:
- `SECRET_KEY`: `***ROTATED_SECRET_KEY***`
- `FIELD_ENCRYPTION_KEY`: `***ROTATED_FIELD_ENCRYPTION_KEY***`
- `DATABASE_URL`: Full PostgreSQL connection string with `doadmin` credentials
- `REDIS_URL`: Full Valkey connection string with credentials
- `OPENAI_API_KEY`: Full `sk-proj-...` key in `.env`
- `SENTRY_DSN`: Full DSN in `.env`

**Impact:** Anyone with repo access can decrypt all veteran PII, hijack sessions, abuse API keys.

**Remediation:**
1. Revoke ALL exposed keys immediately
2. Rotate FIELD_ENCRYPTION_KEY and re-encrypt PII data
3. Scrub git history with `git-filter-repo`
4. Add deployment configs to `.gitignore`
5. Create template files with placeholder values only
6. Install `detect-secrets` pre-commit hook

### 1b. PII Protection — NEEDS WORK

**Implemented correctly:**
- `EncryptedCharField` on `va_file_number` (`accounts/models.py:174`)
- `EncryptedDateField` on `date_of_birth` (`accounts/models.py:185`)
- OCR text ephemeral (not persisted to DB)
- `send_default_pii=False` in Sentry config
- No PII found in logging statements

**Gap:** `claims/models.py:105` — `ai_summary` JSONField stores AI analysis results as plaintext. May contain PII extracted from documents.

### 1c. Input Sanitization — PASS

- All OpenAI calls route through AI Gateway (`agents/ai_gateway.py`)
- `sanitize_input()` removes 14 prompt injection patterns
- No direct `openai` imports outside gateway
- Pydantic schemas validate all AI responses

### 1d. File Upload Security — PASS

- Magic byte validation via `python-magic` (`claims/forms.py:99-149`)
- File size limit: 50MB (`settings.py:500`)
- Page count limit: 100 pages
- Extension whitelist: `.pdf`, `.jpg`, `.jpeg`, `.png`, `.tiff`, `.tif`
- Signed URLs for all file access

### 1e. Authentication & Authorization — NEEDS WORK

- `@login_required` on all user-facing views — PASS
- AI consent decorator (`@require_ai_consent_view`) — PASS
- Document ownership checks (`user=request.user` in queries) — PASS
- **VSO IDOR risk:** Multi-org users can switch organizations via session without per-request re-verification. Case queries don't consistently filter by organization.

### 1f. CSP Headers — NEEDS WORK

- `unsafe-inline` in STYLE_SRC for Tailwind CDN
- `unsafe-inline` removed from SCRIPT_SRC in production (good)
- `CSP_FRAME_ANCESTORS = ("'none'",)` — clickjacking protection
- `CSP_FORM_ACTION = ("'self'",)` — form hijacking protection

### 1g. Rate Limiting — PASS

Comprehensive limits on all public endpoints. IP-based for pre-auth, user-based for post-auth. All AI endpoints limited to 20/hr per user.

### 1h. GraphQL PII Redaction — PASS

`benefits_navigator/schema.py` redacts SSN, VA file numbers, phone, DOB, credit cards. Text truncation: 50KB OCR, 10KB AI summary.

---

## 2. Data Integrity & Accuracy

### 2a. VA Math Implementation — PASS

- Combined rating formula `A + B(1-A)` matches 38 CFR § 4.25 (`va_math.py:60`)
- Rounding rules correct: `Decimal` with `ROUND_HALF_UP` (`va_math.py:157`)
- Edge cases handled: 0%, 100%, single rating, empty list
- Bilateral factor (38 CFR § 4.26): 10% bonus correctly calculated (`va_math.py:120-138`)
- 50+ tests covering all scenarios

### 2b. Compensation Rates — CRITICAL

`examprep/va_math.py:242-346` — Only 2024 rates hardcoded.

- 2025 COLA (3.2%, effective Dec 1, 2024): Missing
- 2026 COLA (2.8%, effective Dec 1, 2025): Missing
- At 100% rating: showing $3,737.85/mo instead of current ~$3,962/mo ($225/mo underestimate)
- SMC rates in `va_special_compensation.py:68-77` also outdated
- Source: https://www.va.gov/disability/compensation-rates/veteran-rates/

### 2c. SMC/TDIU Calculators — PASS

- SMC levels K through S: eligibility criteria match 38 CFR § 3.350
- TDIU schedular: 60%+ single OR 70%+ combined with 40%+ matches 38 CFR § 4.16(a)
- Extraschedular properly noted per 38 CFR § 4.16(b)
- Only 1 test each for TDIU and SMC (minimal coverage)

### 2d. Appeal Deadlines — CRITICAL

`appeals/models.py:293-296` — Applies 1-year deadline to ALL appeal types.

Per VA regulations:
- Higher-Level Review: 1 year (38 CFR § 20.202) — correct
- Board of Veterans' Appeals: 1 year (38 CFR § 20.202) — correct
- **Supplemental Claim: NO time limit (38 CFR § 20.204) — INCORRECT in code**

A veteran filing a supplemental claim 2 years after denial would see "PAST DEADLINE" (wrong). This could discourage legitimate appeals.

### 2e. M21 Manual Content — PASS

- `agents/data/` contains comprehensive M21 content (1.6 MB)
- No XXXX placeholders found
- Last updated: January 2026

### 2f. Exam Prep Guides — PASS (minor wording issue)

- 7 guides, 86 glossary terms, excellent quality
- Minor: Sleep apnea guide says "should receive at least 50%" — should be "may qualify for 50% if documented CPAP compliance"
- Rating criteria match 38 CFR § 4.130 (mental health) and DC 6847 (sleep apnea)

---

## 3. Test Coverage & Quality

### 3a. Coverage Gaps — NEEDS WORK

- `core/tasks.py`: 6 Celery tasks with zero test coverage (retention, cleanup, monitoring)
- TDIU/SMC: Only 1 test each; missing boundary cases (59% vs 60%, 69%+40%)
- Supplemental claim deadline: No test for no-deadline exception
- `examprep/rating_import.py`: Limited coverage

### 3b. Test Isolation — PASS

- OpenAI properly mocked (`conftest.py:669`)
- Celery properly mocked (`conftest.py:732`)
- OCR properly mocked (`conftest.py:743`)
- Rate limiting disabled in tests (`conftest.py:773`)
- MEDIA_ROOT uses tmp directory

### 3c. E2E Tests — PASS

- Playwright tests exist in `tests/e2e/`

### 3d. BDD Scenarios — PASS

- Feature files exist in `tests/bdd/features/`

### 3e. CI Pipeline — NEEDS WORK

- `.github/workflows/security-checks.yml`: migration check + pip-audit
- `.github/workflows/benchmarks.yml`: performance benchmarks
- **Missing: No pytest job in CI. Code can merge with failing tests.**

---

## 4. Production Readiness

### 4a. Error Handling — PASS

- Failed OCR/AI sets document status to 'failed' with user-friendly message
- Celery tasks have `max_retries=3` with exponential backoff
- Custom `templates/500.html` exists
- Sentry captures unhandled exceptions (Django + Celery integrations)

### 4b. Database Performance — NEEDS WORK

- `claims/models.py`: Good indexes on `[user, status]`, `[user, document_type]`, `[created_at]`
- `agents/models.py`: **Missing** composite indexes on `[user, created_at]`, `[user, agent_type]`
- Views generally use `select_related`/`prefetch_related` properly

### 4c. Celery Reliability — CRITICAL

- **Missing `acks_late=True`** on all tasks — messages lost on worker crash
- Global time limits set: 25min soft, 30min hard
- Tasks are idempotent (safe to retry)
- `bind=True` used on all critical tasks

### 4d. Health Checks — PASS

- `check_database()`: SELECT 1 verification
- `check_redis()`: set/get test key
- `check_celery()`: worker count, queue length, task age
- Health endpoint excluded from ALLOWED_HOSTS check via middleware

### 4e. Static Files — NEEDS WORK

- WhiteNoise configured correctly
- **Tailwind via CDN is single point of failure** — if CDN down, site is unstyled
- `templates/500.html` also depends on CDN

### 4f. Logging — PASS

- Production-appropriate levels (INFO)
- No PII in logs
- Comprehensive audit trail via `AuditLog` model
- Sentry configured with `send_default_pii=False`

---

## 5. Accessibility (WCAG AA)

**Overall: ~80% compliant**

### Semantic HTML — PASS
- Heading hierarchy correct throughout (h1→h2→h3)
- Landmark elements properly used (`<main>`, `<nav>`, `<header>`, `<footer>`)
- Skip navigation link present
- Tables use proper `<caption>`, `<th scope>`

### Form Accessibility — CRITICAL
- `rating_calculator.html:59-62`: Spouse checkbox label not properly associated
- Required fields missing `aria-required="true"` across all forms
- Form validation errors not announced via `aria-describedby`

### Dynamic Content (HTMX) — CRITICAL
- `appeals/partials/checklist.html:1`: HTMX updates without `aria-live`
- `rating_calculator.html:577`: Loading spinners lack accessible labels
- No focus management after HTMX content swaps

### Keyboard Navigation — CRITICAL
- `core/partials/feedback_widget.html:8-9`: Uses `<div onclick>` — unreachable by keyboard
- No Escape key handler on feedback widget

### Color & Contrast — PASS
- Body text 21:1 ratio, CTA buttons 6.77:1
- Focus indicators visible (3px blue outline)
- Status indicators include text labels (not color-only)

### Images — PASS
- All decorative SVGs use `aria-hidden="true"`
- Text alternatives present for informational content

---

## 6. Code Quality & Deployment

### Dead Code — PASS
- All models referenced in views/URLs
- No orphaned views without URL mappings

### Consistency — NEEDS WORK
- All views are FBV (intentional but undocumented)
- 21 bare `except Exception:` handlers across views
- Mixed import styles (relative vs absolute)

### Configuration — CRITICAL
- Secrets exposed in version control (covered in Section 1)
- Two conflicting deployment configs: `.do/app.yaml` and `app-spec-fixed.yaml`
- `SITE_URL` fallback is `benefitsnavigator.com` (should be `vabenefitsnavigator.org`)
- `SUPPORT_EMAIL` hardcoded in `settings.py:694`

### Migrations — PASS
- All safe and reversible
- No destructive operations or long-running data transformations

### Docker — PASS (production) / NEEDS WORK (compose)
- Production Dockerfile: non-root user, health checks, layer caching
- Docker Compose: hardcoded credentials repeated in 4 services

### CI/CD — NEEDS WORK
- Has: migration check, pip-audit, dependabot
- Missing: pytest, code linting (black/ruff), integration tests
- Bandit security scan is advisory only (continue-on-error: true)

### Instance Sizing — NEEDS WORK
- `basic-xxs` (512MB) for all services
- Web service likely at 80-95% memory utilization
- Recommend upgrading web to `basic-xs` (1GB)

---

## Top 10 Action Items

| # | Priority | Issue | Effort | Section |
|---|---|---|---|---|
| 1 | P0 | Revoke all exposed secrets, rotate keys, scrub git history | 2-4 hrs | Security |
| 2 | P0 | Add `acks_late=True` to Celery document processing tasks | 30 min | Production |
| 3 | P0 | Fix supplemental claim deadline (should be None, not 1 year) | 1 hr | Data Integrity |
| 4 | P0 | Add 2025/2026 VA compensation rates (2.8% COLA) | 2-3 hrs | Data Integrity |
| 5 | P0 | Add pytest CI job that blocks merges on failure | 1 hr | Code Quality |
| 6 | P1 | Fix VSO IDOR — add org filter to all case queries | 2-3 hrs | Security |
| 7 | P1 | Add database indexes to agent models | 30 min | Production |
| 8 | P1 | Fix accessibility critical items (form labels, keyboard, aria-live) | 3-4 hrs | Accessibility |
| 9 | P2 | Build Tailwind to static CSS, remove `unsafe-inline` CSP | 3-4 hrs | Security |
| 10 | P2 | Add Celery task tests for core/tasks.py retention functions | 2-3 hrs | Testing |

---

## Regulatory Compliance Matrix

| Regulation | Component | Status | Reference |
|---|---|---|---|
| 38 CFR § 4.25 | Combined ratings formula | PASS | `va_math.py:60` |
| 38 CFR § 4.25 | Rounding (0.5+) | PASS | `va_math.py:157` |
| 38 CFR § 4.26 | Bilateral factor (10%) | PASS | `va_math.py:136` |
| 38 CFR § 4.16(a) | TDIU schedular (60%+) | PASS | `va_special_compensation.py:354` |
| 38 CFR § 4.16(a) | TDIU combined (70%+40%+) | PASS | `va_special_compensation.py:366` |
| 38 CFR § 4.16(b) | TDIU extraschedular | PASS | `va_special_compensation.py:378` |
| 38 CFR § 3.350 | SMC levels K-S | PASS | `va_special_compensation.py:18-27` |
| 38 CFR § 20.202 | HLR 1-year deadline | PASS | `appeals/models.py:296` |
| 38 CFR § 20.202 | Board 1-year deadline | PASS | `appeals/models.py:296` |
| 38 CFR § 20.204 | Supplemental NO deadline | **FAIL** | `appeals/models.py:296` |
| VA Rating DC 6847 | Sleep apnea criteria | PASS | `exam_guides_sleep_apnea.json` |
| 38 CFR § 4.130 | Mental health ratings | PASS | `exam_guides_mental_health.json` |

---

## Architecture Strengths

Despite the issues found, the codebase demonstrates strong practices:

- Encryption-by-default for PII (field-level encryption using Fernet)
- AI Gateway pattern centralizes all OpenAI calls with retry, timeout, validation
- Pydantic schemas validate all AI outputs
- Rate limiting on all sensitive endpoints
- Signed URLs protect media file access (HMAC-SHA256)
- Comprehensive audit logging via middleware
- Clean separation of Path A (veterans) and Path B (VSO caseworkers)
- Feature flags enable gradual rollout of VSO features
- Soft deletion with recovery and configurable retention
- Non-root user in production Docker container
- Health checks verify database, Redis, and Celery worker availability

---

**Conclusion:** The architecture is solid and the patterns are right. The P0 items (secrets, crash safety, regulatory accuracy) are the blockers. Once resolved, this is a well-built application close to production-ready.
